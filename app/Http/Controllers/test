<?php

namespace App\Http\Controllers;

use App\Models\Product;
use App\Models\Category;
use App\Models\Supplier;
use Illuminate\Http\Request;
use App\Http\Requests\StoreProductRequest;
use App\Http\Requests\UpdateProductRequest;
use App\Services\NotificationService;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\Log;

class ProductController extends Controller
{
    public function index(Request $request)
    {
        $this->authorize('viewAny', Product::class);
        // ... (logic index của bạn giữ nguyên)
    }

    public function create()
    {
        $this->authorize('create', Product::class);
        $categories = Category::orderBy('name')->pluck('name', 'id');
        $suppliers = Supplier::orderBy('name')->pluck('name', 'id');
        return view('products.create', compact('categories', 'suppliers'))->with(['pageTitle' => 'Thêm sản phẩm mới']);
    }

    public function store(StoreProductRequest $request, NotificationService $notificationService)
    {
        $this->authorize('create', Product::class);

        $validatedData = $request->validated();
        $validatedData['quantity'] = 0; // Luôn đặt số lượng là 0 khi tạo mới

        try {
            $product = Product::create($validatedData);

            if ($request->hasFile('image')) {
                $imagePath = $request->file('image')->store('products', 'public');
                $product->image = $imagePath;
                $product->save();
            }

            // Gửi thông báo vào hệ thống
            $notificationService->notify(
                auth()->user(),
                'success',
                'Sản phẩm mới',
                'Sản phẩm "' . $product->name . '" đã được tạo thành công.'
            );

            // Gửi toast thông báo tức thì
            session()->flash('toast', [
                'type' => 'success',
                'message' => 'Thêm sản phẩm thành công!'
            ]);

            return redirect()->route('admin.products.index');

        } catch (\Exception $e) {
            Log::error('Lỗi khi tạo sản phẩm: ' . $e->getMessage());
            session()->flash('toast', [
                'type' => 'error',
                'message' => 'Đã có lỗi xảy ra, vui lòng thử lại.'
            ]);
            return redirect()->back()->withInput();
        }
    }

    public function show(Product $product)
    {
        $this->authorize('view', $product);
        // ... (logic show của bạn giữ nguyên)
    }

    public function edit(Product $product)
    {
        $this->authorize('update', $product);
        $categories = Category::orderBy('name')->pluck('name', 'id');
        $suppliers = Supplier::orderBy('name')->pluck('name', 'id');
        return view('products.edit', compact('product', 'categories', 'suppliers'))->with(['pageTitle' => 'Chỉnh sửa sản phẩm']);
    }

    public function update(UpdateProductRequest $request, Product $product, NotificationService $notificationService)
    {
        $this->authorize('update', $product);

        $validatedData = $request->validated();
        unset($validatedData['quantity']); // Không cho phép cập nhật số lượng từ form

        try {
            $product->update($validatedData);

            if ($request->hasFile('image')) {
                // Xóa ảnh cũ
                if ($product->image) {
                    Storage::disk('public')->delete($product->image);
                }
                $imagePath = $request->file('image')->store('products', 'public');
                $product->image = $imagePath;
                $product->save();
            }

            // Gửi thông báo vào hệ thống
            $notificationService->notify(
                auth()->user(),
                'info',
                'Cập nhật sản phẩm',
                'Sản phẩm "' . $product->name . '" đã được cập nhật.'
            );

            // Gửi toast thông báo tức thì
            session()->flash('toast', [
                'type' => 'success',
                'message' => 'Cập nhật sản phẩm thành công!'
            ]);

            return redirect()->route('admin.products.index');

        } catch (\Exception $e) {
            Log::error('Lỗi khi cập nhật sản phẩm: ' . $e->getMessage());
            session()->flash('toast', [
                'type' => 'error',
                'message' => 'Cập nhật thất bại, vui lòng thử lại.'
            ]);
            return redirect()->back()->withInput();
        }
    }

    public function destroy(Product $product, NotificationService $notificationService)
    {
        $this->authorize('delete', $product);

        try {
            $productName = $product->name;
            if ($product->image) {
                Storage::disk('public')->delete($product->image);
            }
            $product->delete();

            // Gửi thông báo vào hệ thống
            $notificationService->notify(
                auth()->user(),
                'warning',
                'Xóa sản phẩm',
                'Sản phẩm "' . $productName . '" đã bị xóa.'
            );

            // Gửi toast thông báo tức thì
            session()->flash('toast', [
                'type' => 'success',
                'message' => 'Xóa sản phẩm thành công!'
            ]);

        } catch (\Exception $e) {
            Log::error('Lỗi khi xóa sản phẩm: ' . $e->getMessage());
            session()->flash('toast', [
                'type' => 'error',
                'message' => 'Xóa sản phẩm thất bại.'
            ]);
        }

        return redirect()->route('admin.products.index');
    }

    public function bulkDelete(Request $request, NotificationService $notificationService)
    {
        $this->authorize('delete', Product::class);

        $validated = $request->validate([
            'product_ids' => 'required|array',
            'product_ids.*' => 'exists:products,id',
        ]);

        try {
            $count = count($validated['product_ids']);
            Product::whereIn('id', $validated['product_ids'])->delete();

            // Gửi thông báo vào hệ thống
            $notificationService->notify(
                auth()->user(),
                'warning',
                'Xóa hàng loạt sản phẩm',
                "Đã xóa thành công {$count} sản phẩm."
            );

            // Gửi toast thông báo tức thì
            session()->flash('toast', [
                'type' => 'success',
                'message' => "Đã xóa thành công {$count} sản phẩm."
            ]);

        } catch (\Exception $e) {
            Log::error('Lỗi khi xóa hàng loạt sản phẩm: ' . $e->getMessage());
            session()->flash('toast', [
                'type' => 'error',
                'message' => 'Xóa hàng loạt thất bại.'
            ]);
        }

        return redirect()->route('admin.products.index');
    }
}
